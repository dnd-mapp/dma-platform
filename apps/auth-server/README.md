# ğŸ”‘ auth-server (Identity API)

The `auth-server` is a NestJS-powered backend responsible for Identity and Access Management (IAM) across the D&D Mapp Platform.

## ğŸš€ Features

- **Database:** MariaDB managed via **Prisma ORM**.
- **Authentication:** Username/Password + Multi-factor Authentication (MFA).
- **Token Strategy:** JWT Access Tokens and Opaque Refresh Tokens with **Token Rotation**.
- **Adapter-driven:** Uses the `@prisma/adapter-mariadb` to run without Rust binaries.

## ğŸ›  Local Development

To serve the API locally:

```bash
nx serve auth-server
```

## âš™ï¸ Environment Configuration

This application relies on environment variables defined in the workspace root. We use a single `.env` file at the root of the monorepo to manage cross-application settings (SSL, DNS, and Database credentials).

### 1. Setup

Copy the template variables into your local `.env` file:

```bash
# From the repository root
cat .env.example >> .env # Or manually copy the AUTH_SERVER blocks
```

### 2. Required Variables
Ensure the following variables are configured for `auth-server`:

| Variable               | Description                                     |
|------------------------|-------------------------------------------------|
| `AUTH_SERVER_HOST`     | Set to `localhost.auth.dndmapp.dev`             |
| `AUTH_SERVER_PORT`     | The local port (default: `4350`)                |
| `SSL_PATH` / `SSL_KEY` | Paths to the certificates generated by `mkcert` |
| `AUTH_DB_*`            | Credentials for the MariaDB instance            |
| `AUTH_SERVER_JWT_*`    | Paths to the ES512 keys used for token signing  |

### 3. Database Connection (Prisma)

The Prisma client will automatically construct the connection string using the `AUTH_DB` variables. Ensure your database is running before starting the server.

> [!TIP]
> Do not commit your `.env` file. A template is provided in the root as `.env.example` (or similar) to show the required structure.

## ğŸ” Security Bootstrap

The `auth-server` uses **ES512** (ECDSA P-521) for JWT signing. These keys must be generated and referenced in your `.env` before the application can sign tokens.

### 1. Generate ES512 Keys

You can use `openssl` to generate the required keys:

```bash
# Generate private key
openssl ecparam -name secp521r1 -genkey -noout -out jwt-private.pem

# Extract public key
openssl ec -in jwt-private.pem -pubout -out jwt-public.pem
```

### 2. Configure Environment

Update your root `.env` with the absolute or relative paths:

```text
AUTH_SERVER_JWT_PRIVATE_KEY_PATH="jwt-private.pem"
AUTH_SERVER_JWT_PUBLIC_KEY_PATH="jwt-public.pem"
```

> [!IMPORTANT]
> Keep these keys outside the source tree or ensure they are explicitly added to `.gitignore`.

### Local SSL & DNS

The API is configured to run on port **4350** using the shared platform SSL certificates.

| Application   | Local Domain                 | Port |
|---------------|------------------------------|------|
| `auth-server` | `localhost.auth.dndmapp.dev` | 4350 |

---

## ğŸ—ï¸ Database Management (Prisma)

- **Generate Client:** `nx prisma-generate auth-server`
- **Migrations:** `nx prisma-migrate auth-server`
