// This is your Prisma schema file. Learn more about it in the docs: https://pris.ly/d/prisma-schema
generator client {
    engineType   = "client"
    moduleFormat = "cjs"
    output       = "../src/prisma"
    provider     = "prisma-client"
}

datasource db {
    provider = "mysql"
}

model User {
    id       String @id @default(nanoid())
    username String @unique(map: "uq_user_username")
    password String

    refreshTokens    RefreshToken[]
    authTransactions AuthTransaction[]

    @@map(name: "users")
}

model Client {
    id       String @id @default(nanoid())
    audience String @unique(map: "uq_client_audience")

    redirectUrls     RedirectUrl[]
    authTransactions AuthTransaction[]

    @@map(name: "clients")
}

model RedirectUrl {
    id       String @id @default(nanoid())
    url      String
    clientId String @map(name: "client_id")

    client Client @relation(fields: [clientId], references: [id], map: "fk_client_redirect_urls")

    @@map(name: "redirect_urls")
}

model AuthTransaction {
    id             String    @id @default(nanoid())
    state          String
    nonce          String
    codeChallenge  String    @map(name: "code_challenge")
    redirectUrl    String
    authCode       String?   @map(name: "auth_code")
    authCodeExpiry DateTime? @map(name: "auth_code_expiry")
    userId         String?   @map(name: "user_id")
    clientId       String    @map(name: "client_id")

    client Client @relation(fields: [clientId], references: [id], map: "fk_client_auth_transaction")
    user   User?  @relation(fields: [userId], references: [id], map: "fk_user_auth_transaction")

    @@map(name: "auth_transactions")
}

model RefreshToken {
    id        String   @id @default(nanoid())
    tokenHash String   @map(name: "token_hash")
    expiresAt DateTime @map(name: "expires_at")
    revoked   Boolean  @default(false)
    familyId  String   @default(nanoid()) @map(name: "family_id")
    userId    String   @map(name: "user_id")

    user User @relation(fields: [userId], references: [id], map: "fk_user_refresh_token")

    @@map(name: "refresh_tokens")
}

model TokenBlacklist {
    jti String @id

    @@map(name: "token_blacklist")
}
